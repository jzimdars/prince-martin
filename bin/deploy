#!/usr/bin/env bash
set -euo pipefail

root_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$root_dir"

bin/build

if [[ -f CNAME ]]; then
  cp CNAME _site/CNAME
fi

worktree_dir=".worktrees/gh-pages"

if [[ ! -d "$worktree_dir" ]]; then
  if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
    git worktree add -B gh-pages "$worktree_dir" origin/gh-pages
  else
    git worktree add -B gh-pages "$worktree_dir"
  fi
fi

rsync -a --delete --exclude .git _site/ "$worktree_dir"/

pushd "$worktree_dir" >/dev/null
if [[ -n "$(git status --porcelain)" ]]; then
  git add -A
  git commit -m "Deploy site"
  git push origin gh-pages
else
  echo "No changes to deploy."
fi
popd >/dev/null
