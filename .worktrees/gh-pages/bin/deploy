#!/usr/bin/env bash
set -euo pipefail

root_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$root_dir"

bin/build

# if [[ ! -f CNAME ]]; then
#   echo "CNAME file missing at repo root." >&2
#   exit 1
# fi

# cp CNAME _site/CNAME

worktree_dir=".worktrees/gh-pages"

if [[ ! -d "$worktree_dir" ]]; then
  if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
    git worktree add -B gh-pages "$worktree_dir" origin/gh-pages
  else
    git worktree add -B gh-pages "$worktree_dir"
  fi
fi

rm -rf "$worktree_dir"/*
rsync -a --delete _site/ "$worktree_dir"/

pushd "$worktree_dir" >/dev/null
if [[ -n "$(git status --porcelain)" ]]; then
  git add -A
  git commit -m "Deploy site"
  git push origin gh-pages
else
  echo "No changes to deploy."
fi
popd >/dev/null
